# .github/workflows/build-hhvm.yml
# GitHub Actions pipeline to build HHVM from source.

name: Build HHVM Manually

# This allows the workflow to be triggered manually from the Actions tab in GitHub.
on:
  workflow_dispatch:

jobs:
  #---------------------------------------------------
  # JOB 1: Compile HHVM from source
  #---------------------------------------------------
  build:
    name: Build HHVM
    # Use the latest Ubuntu LTS runner provided by GitHub.
    # Use a 8-core runner for this job.
    runs-on:
      - codebuild-karunscloud-hhvm-build-${{ github.run_id }}-${{ github.run_attempt }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@63424ba62b9b47285b73969542a3821798335013 # v2.8.1
        with:
          egress-policy: audit

      # Cache the build directory to speed up subsequent runs.
      - name: Cache Build Directory
        id: cache-build
        uses: actions/cache@v4
        with:
          path: hhvm/build
          key: ${{ runner.os }}-hhvm-build-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-hhvm-build-

      - name: Install Dependencies
        run: |
          # The runner is Ubuntu-based, so we'll use an Ubuntu codename (e.g., jammy).
          UBUNTU_CODENAME=jammy

          # Install prerequisite packages.
          sudo apt-get update -y
          sudo apt-get install -y \
            ca-certificates \
            curl \
            git \
            cmake \
            make \
            g++ \
            software-properties-common \
            apt-transport-https \
            gnupg

          # Add the HHVM GPG key and repository using the modern, secure method.
          echo "Adding HHVM repository..."
          sudo install -d -m 0755 /usr/share/keyrings
          curl -fsSL https://dl.hhvm.com/conf/hhvm.gpg.key | sudo gpg --dearmor -o /usr/share/keyrings/hhvm.gpg
          echo "deb [signed-by=/usr/share/keyrings/hhvm.gpg] https://dl.hhvm.com/ubuntu ${UBUNTU_CODENAME} main" | sudo tee /etc/apt/sources.list.d/hhvm.list

          # Install the build dependencies for HHVM.
          sudo apt-get update -y
          sudo apt-get build-dep -y hhvm-nightly

      - name: Download and Build HHVM
        run: |
          # 1. Download HHVM source code
          echo "Cloning HHVM repository..."
          git clone --depth=1 git://github.com/facebook/hhvm.git
          cd hhvm
          git submodule update --init --recursive

          # 2. Build HHVM
          echo "Building HHVM... this will take a long time. ‚è≥"
          mkdir build
          cd build
          # Use -j$(nproc) to build in parallel using all available cores.
          cmake -DMYSQL_UNIX_SOCK_ADDR=/var/run/mysqld/mysqld.sock ..
          make -j$(nproc)

      # Upload the entire hhvm directory as an artifact to be used by other jobs.
      - name: Upload HHVM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: hhvm-build
          path: hhvm/

