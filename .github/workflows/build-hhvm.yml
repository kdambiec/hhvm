# .github/workflows/build-hhvm.yml
# GitHub Actions pipeline to build HHVM from source inside a Debian 11 container.

name: Build HHVM in Debian 11

# This allows the workflow to be triggered manually from the Actions tab in GitHub.
on:
  workflow_dispatch:

jobs:
  build:
    name: Build HHVM
    # Use a 8-core runner for this job.
    runs-on:
      - codebuild-karunscloud-hhvm-build-${{ github.run_id }}-${{ github.run_attempt }}
    container:
      image: debian:bullseye-slim

    steps:
      # Cache the build directory to speed up subsequent runs.
      # This action runs on the host but maps to the container's workspace.
      - name: Cache Build Directory
        uses: actions/cache@v4
        with:
          path: /__w/hhvm-from-source/hhvm-from-source/hhvm/build
          key: ${{ runner.os }}-debian11-hhvm-build-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-debian11-hhvm-build-
      
      # The following 'run' steps execute inside the Debian container.
      # Note: 'sudo' is not needed as commands run as root in the container.
      - name: Install Dependencies
        run: |
          DEBIAN_CODENAME=bullseye

          # Update package list and install all necessary tools.
          apt-get update -y
          apt-get install -y --no-install-recommends \
            ca-certificates \
            curl \
            git \
            cmake \
            make \
            g++ \
            gnupg

          # Add the HHVM GPG key and repository.
          echo "Adding HHVM repository..."
          install -d -m 0755 /usr/share/keyrings
          curl -fsSL https://dl.hhvm.com/conf/hhvm.gpg.key | gpg --dearmor -o /usr/share/keyrings/hhvm.gpg
          echo "deb [signed-by=/usr/share/keyrings/hhvm.gpg] https://dl.hhvm.com/debian ${DEBIAN_CODENAME} main" > /etc/apt/sources.list.d/hhvm.list

          # Install the build dependencies for HHVM.
          apt-get update -y
          apt-get build-dep -y hhvm-nightly

      - name: Download and Build HHVM
        run: |
          # 1. Download HHVM source code
          echo "Cloning HHVM repository..."
          git clone --depth=1 git://github.com/facebook/hhvm.git
          cd hhvm
          git submodule update --init --recursive

          # 2. Build HHVM
          echo "Building HHVM... this will take a long time. ‚è≥"
          mkdir build
          cd build
          cmake -DMYSQL_UNIX_SOCK_ADDR=/var/run/mysqld/mysqld.sock ..
          make -j$(nproc)

      # Upload the final build as an artifact for download.
      - name: Upload HHVM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: hhvm-build-debian11
          path: hhvm/

